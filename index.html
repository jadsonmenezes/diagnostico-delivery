<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Diagnóstico de acesso ao delivery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    padding: 16px;
    margin: 0;
  }
  .container {
    max-width: 880px;
    margin: auto;
    background: #020617;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid #1e293b;
  }
  textarea, input, button {
    width: 100%;
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 8px;
    padding: 8px;
    color: #e5e7eb;
  }
  button {
    background: #22c55e;
    border-color: #16a34a;
    cursor: pointer;
    font-weight: bold;
  }
  button:disabled{
    opacity: .6;
    cursor: wait;
  }
  label { margin-bottom: 4px; display: block; }
</style>
</head>
<body>

<div class="container">
<h2>Diagnóstico de acesso ao delivery</h2>

<label>URL da loja</label>
<input id="urlField" type="text" placeholder="https://minha-loja.goomer.app">

<button id="runBtn">Rodar diagnóstico</button>

<label style="margin-top:12px">Resultado:</label>
<textarea id="result" rows="20"></textarea>
<button id="copyBtn">Copiar</button>
<div id="copyStatus" style="font-size:.8rem; margin-top:6px"></div>

</div>

<script>

/* ============================================================
   DETECTOR AVANÇADO DE NAVEGADOR / VERSÃO / SO
   ============================================================ */
function detectBrowser() {
    const ua = navigator.userAgent;

    const browsers = [
        { name: "Edge",  regex: /Edg\/([\d.]+)/ },
        { name: "Chrome", regex: /Chrome\/([\d.]+)/ },
        { name: "Firefox", regex: /Firefox\/([\d.]+)/ },
        { name: "Safari", regex: /Version\/([\d.]+).*Safari/ },
        { name: "Samsung Browser", regex: /SamsungBrowser\/([\d.]+)/ }
    ];

    for (const b of browsers) {
        const match = ua.match(b.regex);
        if (match) return `${b.name} ${match[1]}`;
    }

    return "Navegador não identificado";
}

function detectOS() {
    const ua = navigator.userAgent;

    if (/Windows NT 10/.test(ua)) return "Windows 10";
    if (/Windows NT 11/.test(ua)) return "Windows 11";
    if (/Mac OS X/.test(ua)) return "macOS";
    if (/Android/.test(ua)) return "Android";
    if (/iPhone|iPad|iPod/.test(ua)) return "iOS";
    if (/Linux/.test(ua)) return "Linux";

    return "Sistema operacional não identificado";
}

/* ============================================================
   DETECÇÃO REAL DE TIPO DE CONEXÃO (wifi / ethernet / 4g / 5g)
   ============================================================ */
function detectConnectionType() {
    const nav = navigator;

    // Chrome desktop retorna sempre "4g"; ignoramos isso
    const isDesktop = /Windows|Mac|Linux/i.test(nav.userAgent);
    if (isDesktop) return "Wi-Fi / Ethernet (desktop)";

    const conn = nav.connection || nav.mozConnection || nav.webkitConnection;
    if (!conn) return "Não informado";

    // Android/iOS
    const map = {
        "wifi": "Wi-Fi",
        "ethernet": "Ethernet",
        "4g": "4G",
        "5g": "5G",
        "3g": "3G",
        "2g": "2G"
    };

    const type = conn.type || conn.effectiveType;
    return map[type] || type || "Não identificado";
}

/* ============================================================
   DETECÇÃO DE IPs (IPv4 e IPv6)
   ============================================================ */
async function getIPs() {
    const result = { ipv4: null, ipv6: null };

    try {
        result.ipv4 = (await (await fetch("https://api.ipify.org?format=json")).json()).ip;
    } catch(e){}

    try {
        result.ipv6 = (await (await fetch("https://api64.ipify.org?format=json")).json()).ip;
    } catch(e){}

    // evita falso IPv6==IPv4
    if (result.ipv6 === result.ipv4) result.ipv6 = "não disponível";

    return result;
}

/* ============================================================
   TESTE DE TLS / HANDSHAKE via "image-ping"
   ============================================================ */
async function testTLS(url){
    return new Promise(resolve => {
        const img = new Image();
        const start = performance.now();

        img.onload = () => resolve({
            ok: true,
            ms: performance.now() - start
        });

        img.onerror = () => resolve({
            ok: false,
            ms: performance.now() - start
        });

        // adiciona timestamp para evitar cache
        img.src = url + "/favicon.ico?ts=" + Date.now();
    });
}

/* ============================================================
   TESTE DE HTTP/2 / HTTP/3 (QUIC)
   ============================================================ */
async function testProtocol(url){
    let supportsH3 = false;
    let supportsH2 = false;

    try {
        const r = await fetch(url, { method:"GET" });
        const proto = r.httpVersion || "";
        if (/3/.test(proto)) supportsH3 = true;
        if (/2/.test(proto)) supportsH2 = true;
    } catch(e){}

    return { supportsH2, supportsH3 };
}

/* ============================================================
   TESTE DE SNI (TLS Server Name Indication)
   ============================================================ */
async function testSNI(url){
    try {
        await fetch(url, { mode:"no-cors" });
        return "OK (sem bloqueio SNI)";
    } catch(e) {
        return "Falhou — possível problema de SNI / filtragem HTTPS";
    }
}

/* ============================================================
   DNS FALLBACK
   ============================================================ */
async function testDNS(url){
    try {
        const r = await fetch("https://dns.google/resolve?name=" + new URL(url).hostname);
        const json = await r.json();
        return json.Answer ? json.Answer.map(a => a.data) : "Sem resposta";
    } catch(e){
        return "Falha ao consultar DNS";
    }
}

/* ============================================================
   TESTE DE ACESSO (handshake + fetch)
   ============================================================ */
async function testFetch(url){
    try {
        const start = performance.now();
        await fetch(url, { mode:"no-cors" }); 
        return {
            ok: true,
            ms: performance.now() - start
        };
    } catch(e){
        return {
            ok: false,
            error: e.message
        };
    }
}

/* ============================================================
   EXECUÇÃO PRINCIPAL DO DIAGNÓSTICO
   ============================================================ */
async function runDiagnostic(){
    const url = document.getElementById("urlField").value.trim();
    const resultBox = document.getElementById("result");

    if (!url){
        alert("Informe a URL da loja.");
        return;
    }

    document.getElementById("runBtn").disabled = true;
    resultBox.value = "Executando testes, aguarde...\n";

    const browser = detectBrowser();
    const os = detectOS();
    const conn = detectConnectionType();
    const ips = await getIPs();
    const tls = await testTLS(url);
    const protocol = await testProtocol(url);
    const sni = await testSNI(url);
    const dns = await testDNS(url);
    const fetchTest = await testFetch(url);

    let text = `
=== DIAGNÓSTICO COMPLETO ===

URL testada:
${url}

1) Navegador e dispositivo:
 - Navegador: ${browser}
 - Sistema operacional: ${os}
 - Idioma: ${navigator.language}
 - Online: ${navigator.onLine ? "SIM" : "NÃO"}
 - Tipo de conexão: ${conn}

2) Endereço de rede:
 - IPv4: ${ips.ipv4}
 - IPv6: ${ips.ipv6}

3) Teste TLS/Handshake:
 - Handshake HTTPS: ${tls.ok ? "OK" : "FALHOU"}
 - Latência handshake: ${tls.ms}ms

4) Protocolos suportados:
 - HTTP/2: ${protocol.supportsH2 ? "SIM" : "NÃO"}
 - HTTP/3 (QUIC): ${protocol.supportsH3 ? "SIM" : "NÃO"}

5) SNI (Server Name Indication):
 - Resultado: ${sni}

6) DNS Resolve:
 - Resposta DNS: ${Array.isArray(dns) ? dns.join(", ") : dns}

7) Teste de acesso via Fetch:
 - Conseguiu conectar: ${fetchTest.ok ? "SIM" : "NÃO"}
 ${fetchTest.ok ? `- Latência: ${fetchTest.ms}ms` : `- Erro: ${fetchTest.error}`}

=== FIM DO DIAGNÓSTICO ===
`;

    resultBox.value = text;
    document.getElementById("runBtn").disabled = false;
}

/* ============================================================
   BOTÕES
   ============================================================ */
document.getElementById("runBtn").addEventListener("click", runDiagnostic);

document.getElementById("copyBtn").addEventListener("click", () => {
    navigator.clipboard.writeText(resultBox.value);
    document.getElementById("copyStatus").innerText = "Copiado!";
});

</script>
</body>
</html>
