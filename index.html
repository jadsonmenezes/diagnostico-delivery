<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Diagn√≥stico de acesso ao link do delivery ‚Äì v1.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 16px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #020617;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid #1f2937;
    }
    h1 {
      font-size: 1.3rem;
      margin-top: 0;
      color: #38bdf8;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    input, textarea, button {
      width: 100%;
      box-sizing: border-box;
      font-size: 0.9rem;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 8px;
      background: #020617;
      color: #e5e7eb;
    }
    input:focus, textarea:focus {
      outline: 2px solid #38bdf8;
      outline-offset: 1px;
    }
    button {
      cursor: pointer;
      margin-top: 8px;
      background: #22c55e;
      border-color: #16a34a;
      font-weight: 600;
    }
    button.secondary {
      background: #111827;
      border-color: #4b5563;
      margin-top: 4px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: wait;
    }
    small {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .row {
      margin-bottom: 12px;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #111827;
      border: 1px solid #374151;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    .footer {
      margin-top: 12px;
      font-size: 0.75rem;
      color: #6b7280;
      text-align: center;
    }
    #copyStatus {
      display: block;
      margin-top: 4px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Diagn√≥stico de acesso ao link do delivery ‚Äì v1.0</h1>

    <div class="row">
      <label for="targetUrl">URL da loja que deu erro</label>
      <input id="targetUrl" type="text" placeholder="Ex: https://sua-loja.goomer.app" />
      <small>
        Cole aqui exatamente o link que o cliente tentou abrir (sem prints).
      </small>
    </div>

    <div class="row">
      <button id="runBtn">Rodar diagn√≥stico</button>
    </div>

    <div class="row">
      <label for="output">Resultado do teste (copie e envie via WhatsApp para a loja / suporte):</label>
      <textarea id="output" rows="22" readonly></textarea>
    </div>

    <div class="row">
      <button id="copyBtn" class="secondary">Copiar resultado</button>
      <small id="copyStatus"></small>
    </div>

    <div class="row">
      <div class="tag">N√£o salva dados em servidor</div>
      <div class="tag">Uso interno de suporte</div>
      <div class="tag">Ajuda a identificar erros de certificado / rede</div>
    </div>

    <div class="footer">
      O cliente s√≥ precisa rodar o teste e enviar o texto gerado por WhatsApp.
    </div>
  </div>

  <script>
    const runBtn = document.getElementById("runBtn");
    const output = document.getElementById("output");
    const targetUrlInput = document.getElementById("targetUrl");
    const copyBtn = document.getElementById("copyBtn");
    const copyStatus = document.getElementById("copyStatus");

    function normalizeUrl(url) {
      if (!url) return "";
      url = url.trim();
      if (!/^https?:\/\//i.test(url)) {
        url = "https://" + url;
      }
      return url;
    }

    function parseUserAgent() {
      const ua = navigator.userAgent || "";
      const platform = navigator.platform || "";
      let browserName = "Desconhecido";
      let browserVersion = "";
      let os = "Desconhecido";
      let deviceType = "desktop";

      // Browser
      const edgeMatch = ua.match(/Edg\/([\d.]+)/);
      const chromeMatch = ua.match(/Chrome\/([\d.]+)/);
      const firefoxMatch = ua.match(/Firefox\/([\d.]+)/);
      const safariMatch = ua.match(/Version\/([\d.]+).+Safari/);

      if (edgeMatch) {
        browserName = "Microsoft Edge";
        browserVersion = edgeMatch[1];
      } else if (chromeMatch && !ua.includes("Edg") && !ua.includes("OPR")) {
        browserName = "Google Chrome";
        browserVersion = chromeMatch[1];
      } else if (firefoxMatch) {
        browserName = "Mozilla Firefox";
        browserVersion = firefoxMatch[1];
      } else if (ua.includes("Safari") && safariMatch) {
        browserName = "Apple Safari";
        browserVersion = safariMatch[1];
      }

      // OS
      if (/Windows NT 10\.0/.test(ua)) {
        os = "Windows 10";
      } else if (/Windows NT 11\.0/.test(ua)) {
        os = "Windows 11";
      } else if (/Windows NT/.test(ua)) {
        os = "Windows (vers√£o antiga)";
      } else if (/Android/.test(ua)) {
        os = "Android";
      } else if (/iPhone|iPad|iPod/.test(ua)) {
        os = "iOS";
      } else if (/Mac OS X/.test(ua)) {
        os = "macOS";
      } else if (/Linux/.test(ua)) {
        os = "Linux";
      }

      // Tipo de dispositivo
      if (/Android|iPhone|iPad|iPod|Mobile/i.test(ua)) {
        deviceType = "mobile";
      } else {
        deviceType = "desktop";
      }

      return {
        browserName,
        browserVersion,
        os,
        userAgent: ua,
        platform,
        deviceType
      };
    }

    function getConnectionInfo(deviceType) {
      const nav = navigator || {};
      const conn = nav.connection || nav.mozConnection || nav.webkitConnection || null;
      let effectiveType = conn && conn.effectiveType ? conn.effectiveType : null;
      let downlink = conn && typeof conn.downlink === "number" ? conn.downlink : null;
      let rtt = conn && typeof conn.rtt === "number" ? conn.rtt : null;
      let saveData = conn && typeof conn.saveData === "boolean" ? conn.saveData : null;

      // Label mais humano
      let label = "Indefinido";
      if (deviceType === "mobile") {
        if (effectiveType) {
          label = "Dados m√≥veis (" + effectiveType.toUpperCase() + ")";
        } else {
          label = "Dados m√≥veis (estimado)";
        }
      } else {
        label = "Wi-Fi / Ethernet (estimado)";
      }

      return {
        label,
        raw: {
          effectiveType,
          rtt,
          downlink,
          saveData
        },
        online: typeof nav.onLine === "boolean" ? nav.onLine : null
      };
    }

    async function getIpInfo() {
      const result = { ipv4: null, ipv6: null, errors: [] };

      try {
        const r4 = await fetch("https://api.ipify.org?format=json", { cache: "no-store" });
        const d4 = await r4.json();
        result.ipv4 = d4.ip || null;
      } catch (e) {
        result.errors.push("IPv4: " + e.message);
      }

      try {
        const r6 = await fetch("https://api64.ipify.org?format=json", { cache: "no-store" });
        const d6 = await r6.json();
        result.ipv6 = d6.ip || null;
      } catch (e) {
        result.errors.push("IPv6: " + e.message);
      }

      // Caso bizarro: mesmo valor em v4 e v6
      if (result.ipv4 && result.ipv6 && result.ipv4 === result.ipv6) {
        result.note = "IPv4 e IPv6 iguais (poss√≠vel NAT/CGNAT ou aus√™ncia de IPv6 nativo).";
      }

      return result;
    }

    async function getTimeDiff() {
      const result = {
        serverTime: null,
        localTime: new Date().toISOString(),
        diffMinutes: null,
        warning: null,
        error: null,
        timezone: null
      };

      try {
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        result.timezone = tz || null;
      } catch (e) {
        result.timezone = null;
      }

      try {
        const r = await fetch("https://worldtimeapi.org/api/ip", { cache: "no-store" });
        const data = await r.json();
        if (data && data.utc_datetime) {
          const server = new Date(data.utc_datetime).getTime();
          const local = Date.now();
          const diff = Math.round((local - server) / 60000); // em minutos
          result.serverTime = data.utc_datetime;
          result.diffMinutes = diff;
          if (Math.abs(diff) > 5) {
            result.warning = "Diferen√ßa grande entre hor√°rio do aparelho e o hor√°rio de refer√™ncia. Isso pode causar erro de certificado.";
          }
        }
      } catch (e) {
        result.error = e.message;
      }

      return result;
    }

    async function testTlsHandshake(url) {
      const res = {
        url,
        ok: false,
        durationMs: null,
        errorMessage: null,
        note: null
      };

      if (!url) {
        res.errorMessage = "URL vazia.";
        return res;
      }

      const start = performance.now();
      try {
        // mode: no-cors -> se der erro aqui, √© forte candidato a problema de rede/TLS.
        await fetch(url, {
          method: "GET",
          mode: "no-cors",
          cache: "no-store"
        });
        const end = performance.now();
        res.durationMs = Math.round(end - start);
        res.ok = true;
        res.note = "Requisi√ß√£o chegou ao servidor sem erro vis√≠vel de HTTPS/SSL (handshake provavelmente OK).";
      } catch (e) {
        const end = performance.now();
        res.durationMs = Math.round(end - start);
        res.ok = false;
        res.errorMessage = e.message || String(e);
        res.note = "Falha no acesso via HTTPS pela API do navegador. Pode ser erro de rede, bloqueio na rota ou problema de certificado/TLS.";
      }

      return res;
    }

    async function dnsResolve(hostname) {
      const result = {
        hostname,
        ipv4: [],
        error: null
      };
      if (!hostname) {
        result.error = "Hostname vazio.";
        return result;
      }

      try {
        const url = "https://cloudflare-dns.com/dns-query?name=" +
          encodeURIComponent(hostname) + "&type=A";
        const r = await fetch(url, {
          headers: { "accept": "application/dns-json" },
          cache: "no-store"
        });
        const data = await r.json();
        if (data && Array.isArray(data.Answer)) {
          const ips = data.Answer
            .filter(a => a.type === 1 && a.data)
            .map(a => a.data);
          result.ipv4 = ips;
        }
      } catch (e) {
        result.error = e.message || String(e);
      }

      return result;
    }

    function getDeviceScreen() {
      return {
        width: window.screen && window.screen.width,
        height: window.screen && window.screen.height,
        pixelRatio: window.devicePixelRatio || 1
      };
    }

    function formatTechResult(data) {
      const tlsIcon = data.tls.ok ? "üü¢" : "üî¥";
      const timeIcon = data.time.warning ? "üü°" : "üü¢";
      const onlineIcon = data.connection.online ? "üü¢" : "üî¥";
      const ipIcon = (data.ip.ipv4 || data.ip.ipv6) ? "üü¢" : "üî¥";

      return [
        "=== DIAGN√ìSTICO COMPLETO ‚Äì v2.x ===",
        "",
        "URL testada:",
        data.targetUrl || "n√£o informada",
        "",
        "1) Navegador e dispositivo:",
        " - Navegador: " + data.ua.browserName + " " + (data.ua.browserVersion || ""),
        " - Sistema operacional: " + data.ua.os,
        " - User-Agent completo: " + data.ua.userAgent,
        " - Tipo de dispositivo (estimado): " + data.ua.deviceType,
        " - Tela: " + data.screen.width + "x" + data.screen.height +
          " (pixelRatio " + data.screen.pixelRatio + ")",
        "",
        "2) Conex√£o:",
        " - Status online: " + (data.connection.online ? (onlineIcon + " SIM") : (onlineIcon + " N√ÉO / indefinido")),
        " - Tipo de conex√£o (estimado): " + data.connection.label,
        data.connection.raw.effectiveType
          ? " - effectiveType (navegador): " + data.connection.raw.effectiveType
          : " - effectiveType (navegador): n√£o informado",
        typeof data.connection.raw.downlink === "number"
          ? " - Largura de banda estimada: " + data.connection.raw.downlink + " Mbps"
          : " - Largura de banda estimada: n√£o dispon√≠vel",
        typeof data.connection.raw.rtt === "number"
          ? " - RTT estimado: " + data.connection.raw.rtt + " ms"
          : " - RTT estimado: n√£o dispon√≠vel",
        typeof data.connection.raw.saveData === "boolean"
          ? " - Modo economia de dados: " + (data.connection.raw.saveData ? "ATIVADO" : "desativado")
          : " - Modo economia de dados: n√£o informado",
        "",
        "3) Endere√ßo de rede:",
        ipIcon + " - IPv4: " + (data.ip.ipv4 || "n√£o obtido"),
        " - IPv6: " + (data.ip.ipv6 || "n√£o obtido"),
        data.ip.note ? " - Observa√ß√£o IP: " + data.ip.note : "",
        data.ip.errors && data.ip.errors.length
          ? " - Erros ao obter IP: " + data.ip.errors.join(" | ")
          : "",
        "",
        "4) Hor√°rio do aparelho x servidor:",
        timeIcon + " - Hor√°rio local: " + (data.time.localTime || "n/d"),
        " - Hor√°rio servidor (refer√™ncia): " + (data.time.serverTime || "n/d"),
        " - Diferen√ßa (minutos): " +
          (data.time.diffMinutes === null ? "n/d" : data.time.diffMinutes),
        " - Fuso hor√°rio do aparelho: " + (data.time.timezone || "n√£o identificado"),
        data.time.warning ? " - Aviso: " + data.time.warning : "",
        data.time.error ? " - Erro ao consultar hor√°rio de refer√™ncia: " + data.time.error : "",
        "",
        "5) Teste TLS / Handshake (primeira tentativa):",
        " - URL: " + (data.tls.url || "n/d"),
        " - Status: " + (data.tls.ok ? (tlsIcon + " OK (sem erro vis√≠vel de HTTPS/SSL)") : (tlsIcon + " FALHOU (erro ao tentar acessar via HTTPS)")),
        " - Lat√™ncia: " + (data.tls.durationMs !== null ? data.tls.durationMs + " ms" : "n/d"),
        data.tls.errorMessage ? " - Erro retornado pelo navegador: " + data.tls.errorMessage : "",
        data.tls.note ? " - Observa√ß√£o: " + data.tls.note : "",
        "",
        "6) DNS Resolve (Cloudflare DoH):",
        " - Host consultado: " + (data.dns.hostname || "n/d"),
        data.dns.ipv4 && data.dns.ipv4.length
          ? " - Resposta A: " + data.dns.ipv4.join(", ")
          : " - Resposta A: n√£o foi poss√≠vel obter (pode ser falha de DNS ou bloqueio).",
        data.dns.error ? " - Erro na consulta DNS: " + data.dns.error : "",
        "",
        "=== FIM DO DIAGN√ìSTICO T√âCNICO ==="
      ].join("\n");
    }

    function buildSuggestions(data) {
      const suggestions = [];
      suggestions.push("=== ORIENTA√á√ïES / SUGEST√ïES PARA O CLIENTE ===");
      suggestions.push("");

      // Hor√°rio divergente
      if (data.time.warning) {
        suggestions.push("üü° Hor√°rio do aparelho pode estar incorreto.");
        suggestions.push("- Verifique se a DATA e HORA do celular/computador est√£o corretas.");
        suggestions.push("- Ative a op√ß√£o de 'Data e hora autom√°ticas' nas configura√ß√µes do aparelho.");
        suggestions.push("- Depois disso, feche todas as abas do navegador e tente acessar o link novamente.");
        suggestions.push("");
      }

      // Offline / conex√£o ruim
      if (!data.connection.online || data.connection.raw.effectiveType === "2g") {
        suggestions.push("üü° Conex√£o de internet pode estar inst√°vel ou muito lenta.");
        suggestions.push("- Tente mudar de local dentro da casa para melhorar o sinal.");
        suggestions.push("- Se estiver em dados m√≥veis, teste conectar em uma rede Wi-Fi.");
        suggestions.push("- Feche outros aplicativos que estejam usando internet (streaming, downloads, etc.).");
        suggestions.push("");
      }

      // Falha TLS
      if (!data.tls.ok) {
        suggestions.push("üî¥ N√£o foi poss√≠vel estabelecer conex√£o segura (HTTPS) com o servidor.");
        suggestions.push("- Tente acessar outro site conhecido com HTTPS (por exemplo: https://www.google.com).");
        suggestions.push("- Se outros sites tamb√©m derem erro de seguran√ßa, o problema √© na rede ou no aparelho.");
        suggestions.push("- Desative temporariamente VPN, aplicativos de bloqueio de an√∫ncios ou firewall no aparelho.");
        suggestions.push("- Se estiver em rede corporativa ou Wi-Fi p√∫blico, teste em outra rede (dados m√≥veis, outra Wi-Fi).");
        suggestions.push("");
      }

      // IP / DNS
      if (!data.ip.ipv4 && !data.ip.ipv6) {
        suggestions.push("üî¥ N√£o foi poss√≠vel identificar o endere√ßo IP p√∫blico do aparelho.");
        suggestions.push("- Isso pode indicar problema com a conex√£o de internet ou bloqueio de sa√≠da para alguns servi√ßos.");
        suggestions.push("- Reinicie o modem/roteador e o aparelho, se poss√≠vel.");
        suggestions.push("");
      }

      if (!data.dns.ipv4 || data.dns.ipv4.length === 0 || data.dns.error) {
        suggestions.push("üü° Pode haver problema de DNS na rede.");
        suggestions.push("- Se tiver conhecimento t√©cnico, configure o DNS do aparelho/roteador para 1.1.1.1 (Cloudflare) ou 8.8.8.8 (Google).");
        suggestions.push("- Depois disso, reinicie o aparelho e tente novamente.");
        suggestions.push("");
      }

      // Caso tudo ok (nenhum alerta maior)
      if (
        !data.time.warning &&
        data.connection.online &&
        data.tls.ok &&
        (data.ip.ipv4 || data.ip.ipv6) &&
        data.dns.ipv4 && data.dns.ipv4.length > 0 && !data.dns.error
      ) {
        suggestions.push("üü¢ Pelos testes, o aparelho e a conex√£o parecem normais.");
        suggestions.push("- Se ainda assim o erro aparecer, envie este diagn√≥stico completo para o suporte analisar o caso com mais detalhes.");
        suggestions.push("");
      }

      suggestions.push("=== FIM DAS ORIENTA√á√ïES ===");
      return suggestions.join("\n");
    }

    async function runDiagnostic() {
      const rawUrl = targetUrlInput.value;
      const targetUrl = normalizeUrl(rawUrl);

      runBtn.disabled = true;
      runBtn.textContent = "Rodando testes...";
      copyStatus.textContent = "";
      output.value = "Executando diagn√≥stico, aguarde alguns segundos...";

      try {
        let hostname = "";
        try {
          hostname = targetUrl ? new URL(targetUrl).hostname : "";
        } catch (e) {
          hostname = "";
        }

        const ua = parseUserAgent();
        const connection = getConnectionInfo(ua.deviceType);
        const screen = getDeviceScreen();

        const [ip, time, tls, dns] = await Promise.all([
          getIpInfo(),
          getTimeDiff(),
          testTlsHandshake(targetUrl),
          dnsResolve(hostname)
        ]);

        const data = {
          targetUrl,
          ua,
          connection,
          screen,
          ip,
          time,
          tls,
          dns
        };

        const techText = formatTechResult(data);
        const suggestionsText = buildSuggestions(data);

        output.value = techText + "\n\n" + suggestionsText;
      } catch (e) {
        output.value = "Erro ao executar diagn√≥stico: " + (e.message || String(e));
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = "Rodar diagn√≥stico";
      }
    }

    runBtn.addEventListener("click", runDiagnostic);

    copyBtn.addEventListener("click", async () => {
      copyStatus.textContent = "";
      const text = output.value || "";
      if (!text) {
        copyStatus.textContent = "Nada para copiar.";
        return;
      }

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          // Fallback para navegadores mais antigos
          output.focus();
          output.select();
          document.execCommand("copy");
        }
        copyStatus.textContent = "‚úÖ Resultado copiado. Envie esse texto por WhatsApp para a loja/suporte.";
      } catch (e) {
        copyStatus.textContent = "N√£o foi poss√≠vel copiar automaticamente. Selecione e copie o texto manualmente.";
      }
    });
  </script>
</body>
</html>
