<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Diagn√≥stico de acesso ao delivery ‚Äì v1.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg2: #020617;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --accent-border: #16a34a;
      --input-bg: #020617;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1120;
      color: var(--text);
      margin: 0;
      padding: 16px;
    }
    .container {
      max-width: 840px;
      margin: 0 auto;
      background: var(--bg2);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 4px;
      color: #38bdf8;
    }
    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    input, textarea {
      width: 100%;
      font-size: 0.9rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 8px;
      background: var(--input-bg);
      color: var(--text);
    }
    input:focus, textarea:focus {
      outline: 2px solid #38bdf8;
      outline-offset: 1px;
    }
    textarea {
      resize: vertical;
      min-height: 220px;
      white-space: pre;
    }
    .row {
      margin-bottom: 12px;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    button {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-width: 150px;
      background: transparent;
      color: var(--text);
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent-border);
      color: #022c22;
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: wait;
    }
    .btn-secondary {
      background: #0b1120;
      border-color: #1f2937;
      color: var(--text);
    }
    small {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .footer {
      margin-top: 10px;
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Diagn√≥stico de acesso ao link do delivery</h1>
    <div class="subtitle">
      v1.0 ‚Äì Use para identificar poss√≠veis problemas no aparelho ou na rede do cliente.
    </div>

    <div class="row">
      <label for="targetUrl">URL da loja que deu erro</label>
      <input id="targetUrl" type="text" placeholder="Ex: https://batataria73.goomer.app" />
      <small>Cole exatamente o link que o cliente tentou abrir.</small>
    </div>

    <div class="btn-row">
      <button id="runBtn" class="btn-primary">
        ‚ñ∂Ô∏è Rodar diagn√≥stico
      </button>
      <button id="copyBtn" class="btn-primary">
        üìã Copiar resultado
      </button>
    </div>

    <div class="row">
      <label for="output">Resultado do teste (copie e envie por WhatsApp para o suporte):</label>
      <textarea id="output" readonly></textarea>
      <small id="copyStatus"></small>
    </div>

    <div class="footer">
      Esta p√°gina n√£o salva dados em servidor. Todas as informa√ß√µes ficam vis√≠veis apenas para quem executa o teste.
    </div>
  </div>

  <script>
    const runBtn = document.getElementById("runBtn");
    const copyBtn = document.getElementById("copyBtn");
    const targetUrlInput = document.getElementById("targetUrl");
    const output = document.getElementById("output");
    const copyStatus = document.getElementById("copyStatus");

    function normalizeUrl(raw) {
      if (!raw) return "";
      let url = raw.trim();
      if (!/^https?:\/\//i.test(url)) {
        url = "https://" + url;
      }
      return url;
    }

    // --------- Detec√ß√£o de navegador / SO / dispositivo ----------
    function detectBrowserInfo() {
      const nav = navigator || {};
      const uaData = nav.userAgentData || null;
      const ua = nav.userAgent || "";
      let browserName = "Navegador desconhecido";
      let browserVersion = "";
      let osName = "Sistema operacional desconhecido";

      // Navegador (a partir do UA)
      const browserMatchers = [
        { name: "Microsoft Edge", regex: /Edg\/([\d.]+)/ },
        { name: "Opera", regex: /OPR\/([\d.]+)/ },
        { name: "Brave", regex: /Brave\/([\d.]+)/ },
        { name: "Google Chrome", regex: /Chrome\/([\d.]+)/ },
        { name: "Firefox", regex: /Firefox\/([\d.]+)/ },
        { name: "Safari", regex: /Version\/([\d.]+).*Safari/ },
      ];
      for (const m of browserMatchers) {
        const match = ua.match(m.regex);
        if (match) {
          browserName = m.name;
          browserVersion = match[1];
          break;
        }
      }
      if (!browserVersion && uaData && Array.isArray(uaData.brands)) {
        const brand = uaData.brands[0];
        if (brand) {
          browserName = brand.brand;
          browserVersion = brand.version;
        }
      }

      // SO
      if (/Windows NT 10\.0/.test(ua)) osName = "Windows 10";
      else if (/Windows NT 11\.0/.test(ua)) osName = "Windows 11";
      else if (/Windows NT/.test(ua)) osName = "Windows";
      else if (/Android/.test(ua)) osName = "Android";
      else if (/iPhone|iPad|iPod/.test(ua)) osName = "iOS";
      else if (/Mac OS X/.test(ua)) osName = "macOS";
      else if (/Linux/.test(ua)) osName = "Linux";

      // Tipo de dispositivo
      let deviceType = "desktop";
      if (/Mobile|Android/.test(ua) && !/iPad/.test(ua)) {
        deviceType = "mobile";
      } else if (/iPad|Tablet/.test(ua)) {
        deviceType = "tablet";
      }

      return {
        browserName,
        browserVersion,
        osName,
        deviceType,
        screen: {
          width: window.screen && window.screen.width,
          height: window.screen && window.screen.height,
          pixelRatio: window.devicePixelRatio || 1
        }
      };
    }

    // --------- Conex√£o ----------
    function detectConnection(deviceType) {
      const nav = navigator || {};
      const conn = nav.connection || nav.mozConnection || nav.webkitConnection || null;
      let online = typeof nav.onLine === "boolean" ? nav.onLine : null;

      let typeDescription = "n√£o foi poss√≠vel identificar";
      if (conn && conn.type) {
        if (conn.type === "wifi") typeDescription = "Wi-Fi";
        else if (conn.type === "cellular") typeDescription = "dados m√≥veis (3G/4G/5G)";
        else typeDescription = conn.type;
      } else {
        // heur√≠stica se n√£o houver tipo
        if (deviceType === "desktop") {
          typeDescription = "Wi-Fi ou cabo (desktop)";
        } else if (deviceType === "mobile" || deviceType === "tablet") {
          typeDescription = "Wi-Fi ou dados m√≥veis (n√£o foi poss√≠vel diferenciar)";
        }
      }

      return { online, typeDescription };
    }

    // --------- IP p√∫blico ----------
    async function getIpInfo() {
      const result = { ipv4: null, ipv6: null, errors: [] };
      try {
        const r4 = await fetch("https://api.ipify.org?format=json", { cache: "no-store" });
        const d4 = await r4.json();
        result.ipv4 = d4.ip || null;
      } catch (e) {
        result.errors.push("IPv4: " + e.message);
      }
      try {
        const r6 = await fetch("https://api64.ipify.org?format=json", { cache: "no-store" });
        const d6 = await r6.json();
        result.ipv6 = d6.ip || null;
      } catch (e) {
        result.errors.push("IPv6: " + e.message);
      }

      if (result.ipv4 && result.ipv6 && result.ipv4 === result.ipv6) {
        // caso comum em algumas redes que n√£o t√™m IPv6 de verdade
        result.ipv6 = null;
        result.errors.push("IPv6 n√£o parece dispon√≠vel (mesmo valor do IPv4).");
      }
      return result;
    }

    // --------- Hor√°rio ----------
    async function getTimeDiff() {
      const result = {
        serverTime: null,
        localTime: new Date().toISOString(),
        diffMinutes: null,
        tz: null,
        warning: null,
        error: null
      };
      try {
        const r = await fetch("https://worldtimeapi.org/api/ip", { cache: "no-store" });
        const data = await r.json();
        if (data && data.utc_datetime) {
          const server = new Date(data.utc_datetime).getTime();
          const local = Date.now();
          const diff = Math.round((local - server) / 60000);
          result.serverTime = data.utc_datetime;
          result.diffMinutes = diff;
          result.tz = Intl.DateTimeFormat().resolvedOptions().timeZone || null;

          if (Math.abs(diff) > 5 && Math.abs(diff) <= 60) {
            result.warning = "üü° Diferen√ßa moderada entre hor√°rio do aparelho e hor√°rio de refer√™ncia. Pode causar problemas em certificados.";
          } else if (Math.abs(diff) > 60) {
            result.warning = "üî¥ Diferen√ßa grande entre hor√°rio do aparelho e hor√°rio de refer√™ncia. √â muito recomendado ajustar data/hora.";
          }
        }
      } catch (e) {
        result.error = e.message;
      }
      return result;
    }

    // --------- TLS / Handshake ----------
    async function testTlsHandshake(url) {
      const result = {
        url,
        ok: false,
        durationMs: null,
        errorMessage: null
      };
      if (!url) {
        result.errorMessage = "URL vazia.";
        return result;
      }

      const start = performance.now();
      try {
        // no-cors para apenas testar handshake, sem depender de CORS
        await fetch(url, { method: "GET", mode: "no-cors", cache: "no-store" });
        const end = performance.now();
        result.durationMs = Math.round(end - start);
        result.ok = true;
      } catch (e) {
        const end = performance.now();
        result.durationMs = Math.round(end - start);
        result.ok = false;
        result.errorMessage = e.message || String(e);
      }
      return result;
    }

    // --------- Fetch adicional (pode falhar por CORS) ----------
    async function testFetch(url) {
      const result = {
        ok: false,
        durationMs: null,
        errorMessage: null
      };
      const start = performance.now();
      try {
        const r = await fetch(url, { method: "GET", cache: "no-store" });
        const end = performance.now();
        result.durationMs = Math.round(end - start);
        result.ok = r.ok;
      } catch (e) {
        const end = performance.now();
        result.durationMs = Math.round(end - start);
        result.ok = false;
        result.errorMessage = e.message || String(e);
      }
      return result;
    }

    // --------- DNS via Cloudflare ----------
    async function resolveDnsA(hostname) {
      const result = { answers: [], error: null };
      if (!hostname) {
        result.error = "Hostname vazio.";
        return result;
      }
      try {
        const url = "https://cloudflare-dns.com/dns-query?name=" +
          encodeURIComponent(hostname) + "&type=A";
        const r = await fetch(url, {
          headers: { "accept": "application/dns-json" },
          cache: "no-store"
        });
        const data = await r.json();
        if (Array.isArray(data.Answer)) {
          result.answers = data.Answer
            .filter(a => a.type === 1)
            .map(a => a.data);
        }
      } catch (e) {
        result.error = e.message || String(e);
      }
      return result;
    }

    // --------- Sugest√µes para o cliente ----------
    function buildSuggestions(data) {
      const tips = [];
      const severe = [];

      // offline
      if (data.connection.online === false) {
        severe.push("O aparelho parece estar offline (sem conex√£o √† internet).");
        tips.push(
          "Ativar Wi-Fi ou dados m√≥veis e tentar novamente.",
          "Se estiver no Wi-Fi, conferir se outros sites abrem normalmente."
        );
      }

      // hor√°rio
      if (data.time.diffMinutes !== null && Math.abs(data.time.diffMinutes) > 5) {
        severe.push("Hor√°rio do aparelho est√° diferente do hor√°rio de refer√™ncia.");
        tips.push(
          "Ativar a op√ß√£o de \"Data e hora autom√°ticas\" nas configura√ß√µes do sistema.",
          "Depois de ajustar o hor√°rio, fechar e abrir o navegador novamente."
        );
      }

      // handshake com o link da loja falhou
      if (!data.handshake.ok) {
        severe.push("O navegador n√£o conseguiu iniciar uma conex√£o HTTPS est√°vel com o link informado.");
        tips.push(
          "Fechar todas as abas do navegador e abrir o link novamente.",
          "Tentar abrir o link em aba an√¥nima / modo privado.",
          "Se estiver em dados m√≥veis, testar no Wi-Fi (ou ao contr√°rio).",
          "Desligar VPN, proxy ou bloqueadores de conte√∫do (se estiver usando).",
          "Reiniciar o aparelho (celular ou computador) e tentar novamente."
        );
      }

      // problemas em IP / DNS
      if ((!data.ip.ipv4 && !data.ip.ipv6) || data.dns.error) {
        severe.push("O teste teve dificuldade em obter IP p√∫blico ou resposta de DNS.");
        tips.push(
          "Trocar temporariamente a rede (por exemplo, usar outra Wi-Fi ou dados m√≥veis).",
          "Se for rede corporativa, testar em uma rede dom√©stica ou 4G/5G."
        );
      }

      // se n√£o encontramos nenhum ind√≠cio forte de problema no aparelho/rede
      if (!severe.length && !tips.length) {
        return "7) Sugest√µes para o cliente:\n" +
          " - ‚úÖ N√£o foi identificado nenhum problema claro no aparelho ou na rede neste teste.\n" +
          " - Informe este resultado completo ao suporte para an√°lise mais detalhada.\n";
      }

      // montar texto com foco apenas no lado do cliente
      const lines = [];
      lines.push("7) Sugest√µes para o cliente tentar no aparelho (poss√≠vel problema local):");

      if (severe.length) {
        lines.push(" - Situa√ß√µes detectadas:");
        severe.forEach(s => lines.push("   ‚Ä¢ " + s));
      }

      if (tips.length) {
        lines.push(" - A√ß√µes recomendadas:");
        // remover duplicadas
        const uniqueTips = [...new Set(tips)];
        uniqueTips.forEach(t => lines.push("   ‚Ä¢ " + t));
      }

      return lines.join("\n") + "\n";
    }

    // --------- Formatador de sa√≠da ----------
    function formatResult(data) {
      const iconOnline = data.connection.online === false
        ? "üî¥"
        : (data.connection.online ? "‚úÖ" : "‚ö™");
      let iconTime = "‚ö™";
      if (data.time.diffMinutes !== null) {
        if (Math.abs(data.time.diffMinutes) <= 5) iconTime = "‚úÖ";
        else if (Math.abs(data.time.diffMinutes) <= 60) iconTime = "üü°";
        else iconTime = "üî¥";
      }
      const iconHandshake = data.handshake.ok ? "‚úÖ" : "üî¥";

      const lines = [];

      lines.push("=== DIAGN√ìSTICO COMPLETO ‚Äì v1.0 ===");
      lines.push("");
      lines.push("URL testada:");
      lines.push(data.targetUrl || "n√£o informada");
      lines.push("");

      // 1) Navegador / dispositivo
      lines.push("1) Navegador e dispositivo:");
      const navLine = data.browser.browserVersion
        ? `${data.browser.browserName} ${data.browser.browserVersion}`
        : data.browser.browserName;
      lines.push(" - Navegador: " + navLine);
      lines.push(" - Sistema operacional: " + data.browser.osName);
      lines.push(
        " - Tipo de dispositivo (estimado): " +
        (data.browser.deviceType === "mobile"
          ? "mobile"
          : data.browser.deviceType === "tablet"
          ? "tablet"
          : "desktop")
      );
      lines.push(
        " - Tela: " +
        data.browser.screen.width + "x" +
        data.browser.screen.height +
        " (pixelRatio " + data.browser.screen.pixelRatio + ")"
      );
      lines.push("");

      // 2) Conex√£o
      lines.push("2) Conex√£o:");
      lines.push(` - Estado online (navegador): ${iconOnline} ` +
        (data.connection.online === false ? "N√ÉO" : data.connection.online ? "SIM" : "indefinido"));
      lines.push(" - Tipo de conex√£o (estimado): " + data.connection.typeDescription);
      lines.push("");

      // 3) IP
      lines.push("3) Endere√ßo de rede:");
      lines.push(" - IPv4: " + (data.ip.ipv4 || "n√£o obtido"));
      lines.push(" - IPv6: " + (data.ip.ipv6 || "n√£o dispon√≠vel"));
      if (data.ip.errors && data.ip.errors.length) {
        lines.push(" - Observa√ß√µes IP: " + data.ip.errors.join(" | "));
      }
      lines.push("");

      // 4) Hor√°rio
      lines.push("4) Hor√°rio do aparelho x servidor de refer√™ncia:");
      lines.push(" - Situa√ß√£o geral: " + iconTime + " " +
        (data.time.warning
          ? data.time.warning
          : "Hor√°rio do aparelho aparentemente dentro do esperado."));
      lines.push(" - Hor√°rio local (aparelho): " + (data.time.localTime || "n/d"));
      lines.push(" - Hor√°rio servidor (refer√™ncia): " + (data.time.serverTime || "n/d"));
      lines.push(" - Diferen√ßa (minutos): " +
        (data.time.diffMinutes === null ? "n/d" : data.time.diffMinutes));
      if (data.time.tz) {
        lines.push(" - Fuso hor√°rio do aparelho: " + data.time.tz);
      }
      if (data.time.error) {
        lines.push(" - Erro ao consultar hor√°rio de refer√™ncia: " + data.time.error);
      }
      lines.push("");

      // 5) TLS / handshake alvo
      lines.push("5) Teste TLS / Handshake com o link informado:");
      lines.push(" - Situa√ß√£o: " + iconHandshake + " " +
        (data.handshake.ok
          ? "Conseguiu iniciar a conex√£o HTTPS com o site."
          : "Falha ao iniciar a conex√£o HTTPS com o site."));
      lines.push(" - URL: " + (data.handshake.url || "n/d"));
      lines.push(" - Lat√™ncia aproximada: " +
        (data.handshake.durationMs !== null ? data.handshake.durationMs + "ms" : "n/d"));
      if (data.handshake.errorMessage) {
        lines.push(" - Erro retornado pelo navegador: " + data.handshake.errorMessage);
      }
      lines.push("");

      // 6) DNS
      lines.push("6) DNS (consulta via Cloudflare DoH):");
      if (data.dns.error) {
        lines.push(" - Erro ao consultar DNS: " + data.dns.error);
      } else if (data.dns.answers && data.dns.answers.length) {
        lines.push(" - Resposta A: " + data.dns.answers.join(", "));
      } else {
        lines.push(" - Nenhuma resposta A recebida (pode ser limita√ß√£o do navegador/rede).");
      }
      lines.push("");

      // 7) Sugest√µes (sempre focadas no aparelho/rede do cliente)
      lines.push(buildSuggestions(data));

      lines.push("=== FIM DO DIAGN√ìSTICO ===");
      return lines.join("\n");
    }

    // --------- Execu√ß√£o principal ----------
    async function runDiagnostic() {
      const rawUrl = targetUrlInput.value;
      const targetUrl = normalizeUrl(rawUrl);

      runBtn.disabled = true;
      output.value = "Executando diagn√≥stico, aguarde alguns segundos...";
      copyStatus.textContent = "";

      try {
        const browser = detectBrowserInfo();
        const connection = detectConnection(browser.deviceType);
        const [ip, time, handshake, dns] = await Promise.all([
          getIpInfo(),
          getTimeDiff(),
          testTlsHandshake(targetUrl),
          resolveDnsA((() => {
            try {
              return new URL(targetUrl).hostname;
            } catch {
              return "";
            }
          })())
        ]);

        const data = {
          targetUrl,
          browser,
          connection,
          ip,
          time,
          handshake,
          dns
        };

        const text = formatResult(data);
        output.value = text;
      } catch (e) {
        output.value = "Erro ao executar diagn√≥stico: " + (e.message || String(e));
      } finally {
        runBtn.disabled = false;
      }
    }

    runBtn.addEventListener("click", runDiagnostic);

    copyBtn.addEventListener("click", async () => {
      copyStatus.textContent = "";
      try {
        await navigator.clipboard.writeText(output.value || "");
        copyStatus.textContent = "‚úÖ Resultado copiado. Envie este texto por WhatsApp para o suporte.";
      } catch (e) {
        copyStatus.textContent =
          "N√£o foi poss√≠vel copiar automaticamente. Selecione o texto acima e copie manualmente.";
      }
    });
  </script>
</body>
</html>
